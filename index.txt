<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCRP Complaint Upload Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .drag-active { border-color: #2563eb; background-color: #eff6ff; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="showUploadView()">
                <i class="fas fa-shield-alt text-3xl text-yellow-400"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">NCRP INTELLIGENCE UNIT</h1>
                    <p class="text-xs text-blue-200">National Cyber Crime Reporting Portal Automation</p>
                </div>
            </div>
            <nav class="hidden md:flex space-x-6 text-sm font-medium items-center">
                <button onclick="showUploadView()" class="hover:text-yellow-400 transition flex items-center gap-2"><i class="fas fa-upload"></i> Upload</button>
                <button onclick="showDatabaseView()" class="hover:text-yellow-400 transition flex items-center gap-2"><i class="fas fa-database"></i> Database</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 relative">

        <!-- VIEW 1: UPLOAD -->
        <div id="upload-view" class="flex flex-col items-center justify-center fade-in">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Upload Complaint PDF</h2>
                <p class="text-gray-500 max-w-lg mx-auto">Upload the PDF report. The system will extract suspect data and update the database.</p>
            </div>

            <div class="bg-white w-full max-w-2xl rounded-xl shadow-xl overflow-hidden border border-gray-100 mb-10">
                <div id="drop-zone" class="p-10 border-2 border-dashed border-gray-300 rounded-t-xl bg-gray-50 flex flex-col items-center justify-center transition-colors duration-300 cursor-pointer hover:bg-blue-50 hover:border-blue-300">
                    <div class="mb-4 p-4 bg-blue-100 rounded-full text-blue-600"><i class="fas fa-cloud-upload-alt text-4xl"></i></div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-1">Drag & Drop your PDF here</h3>
                    <input type="file" id="file-input" class="hidden" accept=".pdf">
                    <button onclick="document.getElementById('file-input').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow transition transform hover:scale-105">Browse Files</button>
                    <p id="file-name" class="mt-4 text-sm font-medium text-gray-700 hidden">Selected: <span class="text-blue-600"></span></p>
                </div>

                <div class="p-6 bg-white">
                    <div id="progress-container" class="hidden mb-6">
                        <div class="flex justify-between mb-1"><span class="text-xs font-semibold text-blue-700 uppercase">Processing...</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="reset-btn" class="hidden px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Clear</button>
                        <button id="upload-btn" disabled class="px-6 py-2 text-sm font-bold text-white bg-gray-400 rounded-lg cursor-not-allowed transition duration-300">Upload & Analyze</button>
                    </div>
                    <div id="status-message" class="mt-4 hidden p-4 rounded-lg text-sm flex flex-col md:flex-row items-start md:items-center justify-between gap-4"></div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: DATABASE -->
        <div id="database-view" class="hidden w-full max-w-6xl mx-auto">
            <div class="flex justify-between items-end mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Complaint Database</h2>
                <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 shadow"><i class="fas fa-file-excel mr-2"></i> Export All</button>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto table-container">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold">
                                <th class="p-4">Ack Number</th>
                                <th class="p-4">Category</th>
                                <th class="p-4">Sub Category</th>
                                <th class="p-4">Incident Date</th>
                                <th class="p-4">Total Loss</th>
                                <th class="p-4">Status</th>
                                <th class="p-4 text-center">View</th>
                            </tr>
                        </thead>
                        <tbody id="database-body" class="text-sm text-gray-700 divide-y divide-gray-100">
                            <!-- JS will populate rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL -->
    <div id="details-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-lg shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <p class="text-2xl font-bold text-blue-900">Extracted Data</p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal()"><i class="fas fa-times text-gray-500 hover:text-gray-800 text-xl"></i></div>
                </div>
                <div id="modal-body-content" class="my-5 grid grid-cols-1 gap-4 text-sm">
                    <!-- Content injected by JS -->
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 rounded-lg text-white">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let extractedDataList = [];

        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const fileNameDisplay = document.getElementById('file-name');
            const uploadBtn = document.getElementById('upload-btn');
            const resetBtn = document.getElementById('reset-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const statusMessage = document.getElementById('status-message');
            const dbBody = document.getElementById('database-body');
            const uploadView = document.getElementById('upload-view');
            const databaseView = document.getElementById('database-view');
            const exportBtn = document.getElementById('export-btn');

            // --- 1. LOAD DATABASE ---
            fetchDatabase();

            async function fetchDatabase() {
                try {
                    const response = await fetch('http://127.0.0.1:5000/get_database');
                    const result = await response.json();
                    if(result.status === 'success') {
                        extractedDataList = result.data;
                        renderTable(extractedDataList);
                    }
                } catch (e) {
                    console.log("Connection Error");
                }
            }

            // --- NAVIGATION ---
            window.showUploadView = function() {
                databaseView.classList.add('hidden');
                uploadView.classList.remove('hidden');
            };
            window.showDatabaseView = function() {
                uploadView.classList.add('hidden');
                databaseView.classList.remove('hidden');
            };

            // --- FILE HANDLING ---
            if(dropZone) {
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-active'); });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-active');
                    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
                });
            }
            if(fileInput) fileInput.addEventListener('change', () => { if(fileInput.files.length) handleFile(fileInput.files[0]); });

            function handleFile(file) {
                if (file.type !== 'application/pdf') return alert("Only PDF files allowed.");
                fileNameDisplay.classList.remove('hidden');
                fileNameDisplay.querySelector('span').textContent = file.name;
                uploadBtn.disabled = false;
                uploadBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                uploadBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'cursor-pointer');
                resetBtn.classList.remove('hidden');
            }

            // --- UPLOAD LOGIC ---
            if(uploadBtn) uploadBtn.addEventListener('click', uploadFile);

            async function uploadFile() {
                const file = fileInput.files[0]; 
                if(!file) return;

                uploadBtn.disabled = true;
                progressContainer.classList.remove('hidden');
                progressBar.style.width = "50%";
                statusMessage.classList.add('hidden'); 

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('http://127.0.0.1:5000/process_pdf', { method: 'POST', body: formData });
                    const result = await response.json();
                    progressBar.style.width = "100%";
                    setTimeout(() => { progressContainer.classList.add('hidden'); }, 500);

                    if (result.status === 'success') {
                        extractedDataList = [...extractedDataList, ...result.data];
                        renderTable(extractedDataList);
                        statusMessage.className = "mt-4 p-4 rounded-lg bg-green-100 text-green-700 border border-green-200 block";
                        statusMessage.innerHTML = `<b>Success!</b> Complaint Saved. <button onclick="showDatabaseView()" class="ml-2 underline">View Database</button>`;
                        statusMessage.classList.remove('hidden');
                    } else if (result.status === 'duplicate') {
                        statusMessage.className = "mt-4 p-4 rounded-lg bg-yellow-100 text-yellow-800 border border-yellow-200 block";
                        statusMessage.innerHTML = `<b>Duplicate:</b> ${result.message}`;
                        statusMessage.classList.remove('hidden');
                        uploadBtn.disabled = false;
                    } else { throw new Error(result.message); }

                } catch (error) {
                    progressBar.style.width = "0%";
                    statusMessage.className = "mt-4 p-4 rounded-lg bg-red-100 text-red-700 border border-red-200 block";
                    statusMessage.innerHTML = `<b>Error:</b> ${error.message}`;
                    statusMessage.classList.remove('hidden');
                    uploadBtn.disabled = false;
                }
            }

            // --- RENDER TABLE ---
            function renderTable(data) {
                dbBody.innerHTML = "";
                const reversedData = [...data].reverse();
                reversedData.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition border-b border-gray-100";
                    tr.innerHTML = `
                        <td class="p-4 font-mono text-blue-600 font-bold">${row["NCRP Acknowledgement No."] || '-'}</td>
                        <td class="p-4">${row["Category"] || '-'}</td>
                        <td class="p-4 text-gray-600">${row["Sub Category"] || '-'}</td>
                        <td class="p-4">${row["Incident Date"] || '-'}</td>
                        <td class="p-4 font-bold text-red-600">${row["Total Amount Loss"] || '-'}</td>
                        <td class="p-4"><span class="text-green-600 font-medium"><i class="fas fa-check-circle"></i> Saved</span></td>
                        <td class="p-4 text-center">
                            <button onclick="viewDetails(${index})" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs border">View</button>
                        </td>
                    `;
                    dbBody.appendChild(tr);
                });
            }

            // --- VIEW DETAILS MODAL ---
            let currentDetailIndex = null; // Store index for letter generation

            window.viewDetails = function(displayIndex) {
                 const reversedData = [...extractedDataList].reverse();
                 const data = reversedData[displayIndex];
                 currentDetailIndex = displayIndex; // Save for the button

                 const content = document.getElementById('modal-body-content');
                 
                 const orderedKeys = [
                     "NCRP Acknowledgement No.", "CSR No", "Category", "Sub Category",
                     "Incident Date", "Incident Time", "Complaint Date", "Complaint Name",
                     "Complaint Address", "Complaint Phone No.", "Complaint Mail Id",
                     "Suspect phone No.", "Suspect social Media Id", "Total Amount Loss", "Additional details"
                 ];

                 let html = "";
                 orderedKeys.forEach(key => {
                     const value = data[key] || "";
                     html += `
                        <div class="grid grid-cols-3 border-b pb-2 items-start">
                            <span class="font-bold text-gray-600 col-span-1">${key}:</span> 
                            <span class="col-span-2 text-gray-800 break-words font-medium">${value}</span>
                        </div>`;
                 });
                 
                 // Add the GENERATE LETTER Button at the bottom
                 html += `
                    <div class="mt-6 pt-4 border-t border-gray-200 flex justify-center">
                        <button onclick="generateRequestLetter()" class="flex items-center gap-2 bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition transform hover:scale-105">
                            <i class="fas fa-file-pdf"></i> Generate Request Letter
                        </button>
                    </div>
                 `;

                 content.innerHTML = html;
                 document.getElementById('details-modal').classList.remove('opacity-0', 'pointer-events-none');
            };

            window.closeModal = function() {
                document.getElementById('details-modal').classList.add('opacity-0', 'pointer-events-none');
            };

            // --- GENERATE REQUEST LETTER FUNCTION ---
            window.generateRequestLetter = function() {
                const reversedData = [...extractedDataList].reverse();
                const data = reversedData[currentDetailIndex];
                const today = new Date().toLocaleDateString('en-IN');

                // Create the letter HTML
                const letterHTML = `
                <html>
                <head>
                    <title>Request Letter - ${data["CSR No"]}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 40px; line-height: 1.6; max-width: 800px; mx-auto; }
                        .header { font-weight: bold; margin-bottom: 20px; }
                        .title { text-align: center; font-weight: bold; text-decoration: underline; margin: 20px 0; }
                        .content { margin-bottom: 20px; text-align: justify; }
                        .table-container { margin: 20px 0; width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; text-align: left; }
                        .footer { margin-top: 50px; }
                        .signature { float: right; text-align: center; font-weight: bold; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body contenteditable="true"> <div style="text-align:center; margin-bottom: 10px;">
                        <span style="font-weight:bold; font-size: 14pt;">सत्यमेव जयते</span>
                    </div>

                    <div class="header">
                        From<br>
                        Inspector of Police,<br>
                        Cyber Crime Police Station,<br>
                        The Nilgiris.
                    </div>

                    <div class="header">
                        To<br>
                        The Nodal Officer,<br>
                        [ENTER BANK NAME HERE]<br> </div>

                    <div class="content">
                        <strong>Sub:</strong> Financial Fraud - Provide Beneficiary Account details for Investigation regards.<br>
                        <strong>Ref:</strong> Nilgiris District Cyber Crime Police Station CSR No. <strong>${data["CSR No"] || "____"}</strong>, Dated: ${today}<br>
                        <strong>NCRP Ack No:</strong> <strong>${data["NCRP Acknowledgement No."] || "____"}</strong> - Date: ${data["Incident Date"] || "____"}
                    </div>

                    <div class="content">
                        Sir/Madam,<br><br>
                        As per the above cited reference, a case has been registered in Nilgiris Cyber Crime Police Station. The fraudulent transaction account details are as follows:
                    </div>

                    <table class="table-container">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th>S.No</th>
                                <th>Bank Name</th>
                                <th>Account No.</th>
                                <th>IFSC Code</th>
                                <th>Transaction ID / Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>[Enter Bank]</td>
                                <td>${data["Suspect phone No."] || data["Suspect Account No."] || "N/A"}</td>
                                <td>[Enter IFSC]</td>
                                <td>Rs. ${data["Total Amount Loss"] || ""}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="content">
                        It is requested to provide the following details for investigation purposes:
                        <ul>
                            <li>Account holder details (KYC)</li>
                            <li>Account statements</li>
                            <li>Linked mobile numbers & emails</li>
                            <li>Transaction history</li>
                            <li>IP logs (if available)</li>
                        </ul>
                    </div>

                    <div class="footer">
                        <div class="signature">
                            Inspector of Police<br>
                            Cyber Crime Police Station<br>
                            The Nilgiris.
                        </div>
                    </div>

                    <div style="position: fixed; bottom: 20px; right: 20px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: blue; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Save as PDF / Print</button>
                    </div>

                </body>
                </html>
                `;

                // Open new window and print
                const printWindow = window.open('', '_blank');
                printWindow.document.write(letterHTML);
                printWindow.document.close();
            };

            // --- EXPORT & RESET LOGIC ---
            if(exportBtn) exportBtn.addEventListener('click', () => {
                if (!extractedDataList.length) return alert("No data!");
                const headers = ["NCRP Acknowledgement No.", "Category", "Sub Category", "Total Amount Loss", "Suspect Account No.", "Complaint Phone No."];
                const csvRows = [headers.join(',')];
                for (const row of extractedDataList) {
                    csvRows.push(headers.map(h => `"${row[h]||''}"`).join(','));
                }
                const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(blob);
                a.download = `NCRP_Data.csv`;
                a.click();
            });

            if(resetBtn) resetBtn.addEventListener('click', () => {
                fileInput.value = ''; 
                fileNameDisplay.classList.add('hidden');
                statusMessage.classList.add('hidden');
                progressContainer.classList.add('hidden');
                uploadBtn.disabled = true;
                uploadBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                uploadBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'cursor-pointer');
                resetBtn.classList.add('hidden');
            });
        });
    </script>
</body>
</html>